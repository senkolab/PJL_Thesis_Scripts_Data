%This script computes the density matrix in the equilibrated state from the
%optical Bloch equations. 
%The script is written in a way that requires the inputs to be pre-defined
%in the workspace and it will output the desired output in the workspace
%at the end. The input definitions are variables that need to be
%pre-defined in the workspace before the script is run.
%
%Output definition:
%sigma_end: A 1-dimensional array which contains each element of the
%density matrix in the equilibrated state. To find the desired density
%matrix element, index it with sigma_end(c[XX]_[xx].*c[YY]_[yy]_conj == 1). 
%For example, sigma_end(cp1_1m.*cp1_1m_conj == 1) returns the density matrix
%element for cp1_1m.*cp1_1m_conj.
%
%Input definition:
%Omega_[XX][YY]: A scalar number. Denotes the Rabi frequency in MHz for the
%transition from the [XX] level to [YY] level. e.g. Omega_S1P2 denotes the
%Rabi frequency from the S_{1/2}, F = 1 level to the P_{1/2}, F = 2 level.
%Rabi frequencies for all transitions are all preset to zeros from
%Ba137_SPDZeeman_Levels_OpticalBloch_init_prototype.m. To "turn on" the
%desired transitions, the corresponding Omega_[XX][YY] variables need to be
%set to the desired Rabi frequencies in the workspace.
%Delta_[XX][YY]: A scalar number. Denotes the laser detuning in MHz for the
%transition from [XX] level to [YY] level. e.g. Delta_S1P2 denotes the
%laser detuning from the S_{1/2}, F = 1 level to the P_{1/2}, F = 2 level.
%Laser detunings for all transitions are all preset to zeros from 
%Ba137_SPDZeeman_Levels_OpticalBloch_init_prototype.m. To "turn on" the
%desired transitions, the corresponding Delta_[XX][YY] variables need to be
%set to the desired laser detunings.
%theta_s: A scalar number. The linear polarization of the laser driving the
%S_{1/2} to P_{1/2} transitions in radian. Zero corresponds to complete 
%sigma-polarization.
%theta_d: A scalar number. The linear polarization of the laser driving the
%D_{3/2} to P_{1/2} transitions in radian. Zero corresponds to complete 
%sigma-polarization.

Planck_h = 6.62607015*(10^(-34)); %Planck constant in SI units.
uB = 9.274009994*10^(-24); %Bohr magneton in SI units.
B = 1*470*10^(-6); %Magnetic field in Tesla

%Lines 42 to 44 define the L angular momenta for S, P and D levels.
L_S = 0;
L_P = 1;
L_D = 2;

S_12 = 1/2; %Defines the angular momentum for electron spin.
J_12 = 1/2; %Defines J = 1/2 angular momentum.
J_32 = 3/2; %Defines J = 3/2 angular momentum.

%Lines 51 to 58 define the F angular momentum for each hyperfine level.
F_s1 = 1;
F_s2 = 2;
F_p1 = 1;
F_p2 = 2;
F_d0 = 0;
F_d1 = 1;
F_d2 = 2;
F_d3 = 3;

g_S = 2; %g-factor for electron spin.
g_L = 1; %g-factor for orbital angular momentum.

I_spin = 3/2; %Nuclear spin for Ba-137.

%Lines 66 to 73 compute the g-factor for each J level.
g_J_S = g_L*(J_12*(J_12 + 1) - S_12*(S_12 + 1) + L_S*(L_S + 1))/(2*J_12*(J_12 + 1))...
    + g_S*(J_12*(J_12 + 1) + S_12*(S_12 + 1) - L_S*(L_S + 1))/(2*J_12*(J_12 + 1));

g_J_P = g_L*(J_12*(J_12 + 1) - S_12*(S_12 + 1) + L_P*(L_P + 1))/(2*J_12*(J_12 + 1))...
    + g_S*(J_12*(J_12 + 1) + S_12*(S_12 + 1) - L_P*(L_P + 1))/(2*J_12*(J_12 + 1));

g_J_D = g_L*(J_32*(J_32 + 1) - S_12*(S_12 + 1) + L_D*(L_D + 1))/(2*J_32*(J_32 + 1))...
    + g_S*(J_32*(J_32 + 1) + S_12*(S_12 + 1) - L_D*(L_D + 1))/(2*J_32*(J_32 + 1));

%Lines 76 to 82 compute the g-factor for each hyperfine level.
g_F_s1 = g_J_S*(F_s1*(F_s1 + 1) - I_spin*(I_spin + 1) + J_12*(J_12 + 1))/(2*F_s1*(F_s1 + 1));
g_F_s2 = g_J_S*(F_s2*(F_s2 + 1) - I_spin*(I_spin + 1) + J_12*(J_12 + 1))/(2*F_s2*(F_s2 + 1));
g_F_p1 = g_J_P*(F_p1*(F_p1 + 1) - I_spin*(I_spin + 1) + J_12*(J_12 + 1))/(2*F_p1*(F_p1 + 1));
g_F_p2 = g_J_P*(F_p2*(F_p2 + 1) - I_spin*(I_spin + 1) + J_12*(J_12 + 1))/(2*F_p2*(F_p2 + 1));
g_F_d1 = g_J_D*(F_d1*(F_d1 + 1) - I_spin*(I_spin + 1) + J_32*(J_32 + 1))/(2*F_d1*(F_d1 + 1));
g_F_d2 = g_J_D*(F_d2*(F_d2 + 1) - I_spin*(I_spin + 1) + J_32*(J_32 + 1))/(2*F_d2*(F_d2 + 1));
g_F_d3 = g_J_D*(F_d3*(F_d3 + 1) - I_spin*(I_spin + 1) + J_32*(J_32 + 1))/(2*F_d3*(F_d3 + 1));


%Lines 87 to 95 compute the Zeeman splitting for each hyperfine level in
%MHz.
Delta_zs1 = 10^(-6)*g_F_s1*uB*B/Planck_h;
Delta_zs2 = 10^(-6)*g_F_s2*uB*B/Planck_h;

Delta_zd1 = 10^(-6)*g_F_d1*uB*B/Planck_h;
Delta_zd2 = 10^(-6)*g_F_d2*uB*B/Planck_h;
Delta_zd3 = 10^(-6)*g_F_d3*uB*B/Planck_h;

Delta_zp1 = 10^(-6)*g_F_p1*uB*B/Planck_h;
Delta_zp2 = 10^(-6)*g_F_p2*uB*B/Planck_h;

%Lines 100 and 101 compute the composition of the laser polarization for the
%cooling an repump lasers in terms of sigma-plus, sigma-minus and pi
%polarizations.
pol_sp_m = sqrt((cos(theta_s)^2)/2); pol_sp_0 = sqrt(sin(theta_s)^2); pol_sp_p = sqrt((cos(theta_s)^2)/2);
pol_dp_m = sqrt((cos(theta_d)^2)/2); pol_dp_0 = sqrt(sin(theta_d)^2); pol_dp_p = sqrt((cos(theta_d)^2)/2);

gamma_S = 95.3; %Decay rate of P_1/2 state to S_1/2 in MHz
gamma_D = 31; %Decay rate of P_1/2 state to D_3/2 in MHz

%Lines 109 to 179 initialize the 1D array corresponding to each of the 32
%states. Each array is an array of 31 zeros and 1 one. Different states
%have the one in different positions.
s1_1m = zeros(1,32);
s1_1m(1) = 1;
s1_0 = zeros(1,32);
s1_0(2) = 1;
s1_1p = zeros(1,32);
s1_1p(3) = 1;

s2_2m = zeros(1,32);
s2_2m(4) = 1;
s2_1m = zeros(1,32);
s2_1m(5) = 1;
s2_0 = zeros(1,32);
s2_0(6) = 1;
s2_1p = zeros(1,32);
s2_1p(7) = 1;
s2_2p = zeros(1,32);
s2_2p(8) = 1;

d0_0 = zeros(1,32);
d0_0(9) = 1;

d1_1m = zeros(1,32);
d1_1m(10) = 1;
d1_0 = zeros(1,32);
d1_0(11) = 1;
d1_1p = zeros(1,32);
d1_1p(12) = 1;

d2_2m = zeros(1,32);
d2_2m(13) = 1;
d2_1m = zeros(1,32);
d2_1m(14) = 1;
d2_0 = zeros(1,32);
d2_0(15) = 1;
d2_1p = zeros(1,32);
d2_1p(16) = 1;
d2_2p = zeros(1,32);
d2_2p(17) = 1;

d3_3m = zeros(1,32);
d3_3m(18) = 1;
d3_2m = zeros(1,32);
d3_2m(19) = 1;
d3_1m = zeros(1,32);
d3_1m(20) = 1;
d3_0 = zeros(1,32);
d3_0(21) = 1;
d3_1p = zeros(1,32);
d3_1p(22) = 1;
d3_2p = zeros(1,32);
d3_2p(23) = 1;
d3_3p = zeros(1,32);
d3_3p(24) = 1;

p1_1m = zeros(1,32);
p1_1m(25) = 1;
p1_0 = zeros(1,32);
p1_0(26) = 1;
p1_1p = zeros(1,32);
p1_1p(27) = 1;

p2_2m = zeros(1,32);
p2_2m(28) = 1;
p2_1m = zeros(1,32);
p2_1m(29) = 1;
p2_0 = zeros(1,32);
p2_0(30) = 1;
p2_1p = zeros(1,32);
p2_1p(31) = 1;
p2_2p = zeros(1,32);
p2_2p(32) = 1;


%Lines 187 to 257 initialize the 1D arrays of size 32^2 for each array. The
%array size correspond to the total number of elements in the density
%matrix. The arrays are initialized such that array1.*array2_conj gives an
%array of 32^2 - 1 zeros and 1 one. The position of the one define the
%density matrix element.
cs1_1m = kron(s1_1m,ones(1,32));
cs1_1m_conj = kron(ones(1,32),s1_1m);
cs1_0 = kron(s1_0,ones(1,32));
cs1_0_conj = kron(ones(1,32),s1_0);
cs1_1p = kron(s1_1p,ones(1,32));
cs1_1p_conj = kron(ones(1,32),s1_1p);

cs2_2m = kron(s2_2m,ones(1,32));
cs2_2m_conj = kron(ones(1,32),s2_2m);
cs2_1m = kron(s2_1m,ones(1,32));
cs2_1m_conj = kron(ones(1,32),s2_1m);
cs2_0 = kron(s2_0,ones(1,32));
cs2_0_conj = kron(ones(1,32),s2_0);
cs2_1p = kron(s2_1p,ones(1,32));
cs2_1p_conj = kron(ones(1,32),s2_1p);
cs2_2p = kron(s2_2p,ones(1,32));
cs2_2p_conj = kron(ones(1,32),s2_2p);

cd0_0 = kron(d0_0,ones(1,32));
cd0_0_conj = kron(ones(1,32),d0_0);

cd1_1m = kron(d1_1m,ones(1,32));
cd1_1m_conj = kron(ones(1,32),d1_1m);
cd1_0 = kron(d1_0,ones(1,32));
cd1_0_conj = kron(ones(1,32),d1_0);
cd1_1p = kron(d1_1p,ones(1,32));
cd1_1p_conj = kron(ones(1,32),d1_1p);

cd2_2m = kron(d2_2m,ones(1,32));
cd2_2m_conj = kron(ones(1,32),d2_2m);
cd2_1m = kron(d2_1m,ones(1,32));
cd2_1m_conj = kron(ones(1,32),d2_1m);
cd2_0 = kron(d2_0,ones(1,32));
cd2_0_conj = kron(ones(1,32),d2_0);
cd2_1p = kron(d2_1p,ones(1,32));
cd2_1p_conj = kron(ones(1,32),d2_1p);
cd2_2p = kron(d2_2p,ones(1,32));
cd2_2p_conj = kron(ones(1,32),d2_2p);

cd3_3m = kron(d3_3m,ones(1,32));
cd3_3m_conj = kron(ones(1,32),d3_3m);
cd3_2m = kron(d3_2m,ones(1,32));
cd3_2m_conj = kron(ones(1,32),d3_2m);
cd3_1m = kron(d3_1m,ones(1,32));
cd3_1m_conj = kron(ones(1,32),d3_1m);
cd3_0 = kron(d3_0,ones(1,32));
cd3_0_conj = kron(ones(1,32),d3_0);
cd3_1p = kron(d3_1p,ones(1,32));
cd3_1p_conj = kron(ones(1,32),d3_1p);
cd3_2p = kron(d3_2p,ones(1,32));
cd3_2p_conj = kron(ones(1,32),d3_2p);
cd3_3p = kron(d3_3p,ones(1,32));
cd3_3p_conj = kron(ones(1,32),d3_3p);

cp1_1m = kron(p1_1m,ones(1,32));
cp1_1m_conj = kron(ones(1,32),p1_1m);
cp1_0 = kron(p1_0,ones(1,32));
cp1_0_conj = kron(ones(1,32),p1_0);
cp1_1p = kron(p1_1p,ones(1,32));
cp1_1p_conj = kron(ones(1,32),p1_1p);

cp2_2m = kron(p2_2m,ones(1,32));
cp2_2m_conj = kron(ones(1,32),p2_2m);
cp2_1m = kron(p2_1m,ones(1,32));
cp2_1m_conj = kron(ones(1,32),p2_1m);
cp2_0 = kron(p2_0,ones(1,32));
cp2_0_conj = kron(ones(1,32),p2_0);
cp2_1p = kron(p2_1p,ones(1,32));
cp2_1p_conj = kron(ones(1,32),p2_1p);
cp2_2p = kron(p2_2p,ones(1,32));
cp2_2p_conj = kron(ones(1,32),p2_2p);

ind_array = eye(numel(s1_0)); %Create an indexing matrix, which is a 32x32 identity matrix.

%Lines 262 to 268 basically does what lines 187 to 257 did, but combine all 
%the 1D arrays into 2 2D arrays instead - c_array and c_conj_array.
c_array = nan(numel(s1_0),numel(cs1_0));
c_conj_array = nan(numel(s1_0),numel(cs1_0));

for c_array_count=1:numel(s1_0)
    c_array(c_array_count,:) = kron(ind_array(c_array_count,:),ones(1,numel(s1_0)));
    c_conj_array(c_array_count,:) = kron(ones(1,numel(s1_0)),ind_array(c_array_count,:));
end

%Lines 272 to 526 compute the differential equation for each state.
cs1_1m_prime = -1i.*(Delta_S1P1 + Delta_S1P2 - Delta_zs1).*cs1_1m...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m1m.*pol_sp_0.*cp1_1m + A_S1P1_1m0.*pol_sp_p.*cp1_0)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m2m.*pol_sp_m.*cp2_2m + A_S1P2_1m1m.*pol_sp_0.*cp2_1m + A_S1P2_1m0.*pol_sp_p.*cp2_0);
cs1_1m_prime_conj = conj(-1i.*(Delta_S1P1 + Delta_S1P2 - Delta_zs1).*cs1_1m_conj...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m1m.*pol_sp_0.*cp1_1m_conj + A_S1P1_1m0.*pol_sp_p.*cp1_0_conj)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m2m.*pol_sp_m.*cp2_2m_conj + A_S1P2_1m1m.*pol_sp_0.*cp2_1m_conj + A_S1P2_1m0.*pol_sp_p.*cp2_0_conj));

cs1_0_prime = -1i.*(Delta_S1P1 + Delta_S1P2).*cs1_0...
    -1i.*(Omega_S1P1/2).*(A_S1P1_01m.*pol_sp_m.*cp1_1m + A_S1P1_00.*pol_sp_0.*cp1_0 + A_S1P1_01p.*pol_sp_p.*cp1_1p)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_01m.*pol_sp_m.*cp2_1m + A_S1P2_00.*pol_sp_0.*cp2_0 + A_S1P2_01p.*pol_sp_p.*cp2_1p);
cs1_0_prime_conj = conj(-1i.*(Delta_S1P1 + Delta_S1P2).*cs1_0_conj...
    -1i.*(Omega_S1P1/2).*(A_S1P1_01m.*pol_sp_m.*cp1_1m_conj + A_S1P1_00.*pol_sp_0.*cp1_0_conj + A_S1P1_01p.*pol_sp_p.*cp1_1p_conj)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_01m.*pol_sp_m.*cp2_1m_conj + A_S1P2_00.*pol_sp_0.*cp2_0_conj + A_S1P2_01p.*pol_sp_p.*cp2_1p_conj));

cs1_1p_prime = -1i.*(Delta_S1P1 + Delta_S1P2 + Delta_zs1).*cs1_1p...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1p0.*pol_sp_m.*cp1_0 + A_S1P1_1p1p.*pol_sp_0.*cp1_1p)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1p0.*pol_sp_m.*cp2_0 + A_S1P2_1p1p.*pol_sp_0.*cp2_1p + A_S1P2_1p2p.*pol_sp_p.*cp2_2p);
cs1_1p_prime_conj = conj(-1i.*(Delta_S1P1 + Delta_S1P2 + Delta_zs1).*cs1_1p_conj...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1p0.*pol_sp_m.*cp1_0_conj + A_S1P1_1p1p.*pol_sp_0.*cp1_1p_conj)...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1p0.*pol_sp_m.*cp2_0_conj + A_S1P2_1p1p.*pol_sp_0.*cp2_1p_conj + A_S1P2_1p2p.*pol_sp_p.*cp2_2p_conj));

cs2_2m_prime = -1i.*(Delta_S2P1 + Delta_S2P2 - 2.*Delta_zs2).*cs2_2m...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2m1m.*pol_sp_p.*cp1_1m)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m2m.*pol_sp_0.*cp2_2m + A_S2P2_2m1m.*pol_sp_p.*cp2_1m);
cs2_2m_prime_conj = conj(-1i.*(Delta_S2P1 + Delta_S2P2 - 2.*Delta_zs2).*cs2_2m_conj...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2m1m.*pol_sp_p.*cp1_1m_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m2m.*pol_sp_0.*cp2_2m_conj + A_S2P2_2m1m.*pol_sp_p.*cp2_1m_conj));

cs2_1m_prime = -1i.*(Delta_S2P1 + Delta_S2P2 - Delta_zs2).*cs2_1m...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1m1m.*pol_sp_0.*cp1_1m + A_S2P1_1m0.*pol_sp_p.*cp1_0)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1m2m.*pol_sp_m.*cp2_2m + A_S2P2_1m1m.*pol_sp_0.*cp2_1m + A_S2P2_1m0.*pol_sp_p.*cp2_0);
cs2_1m_prime_conj = conj(-1i.*(Delta_S2P1 + Delta_S2P2 - Delta_zs2).*cs2_1m_conj...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1m1m.*pol_sp_0.*cp1_1m_conj + A_S2P1_1m0.*pol_sp_p.*cp1_0_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1m2m.*pol_sp_m.*cp2_2m_conj + A_S2P2_1m1m.*pol_sp_0.*cp2_1m_conj + A_S2P2_1m0.*pol_sp_p.*cp2_0_conj));

cs2_0_prime = -1i.*(Delta_S2P1 + Delta_S2P2).*cs2_0...
    -1i.*(Omega_S2P1/2).*(A_S2P1_01m.*pol_sp_m.*cp1_1m + A_S2P1_00.*pol_sp_0.*cp1_0 + A_S2P1_01p.*pol_sp_p.*cp1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_01m.*pol_sp_m.*cp2_1m + A_S2P2_00.*pol_sp_0.*cp2_0 + A_S2P2_01p.*pol_sp_p.*cp2_1p);
cs2_0_prime_conj = conj(-1i.*(Delta_S2P1 + Delta_S2P2).*cs2_0_conj...
    -1i.*(Omega_S2P1/2).*(A_S2P1_01m.*pol_sp_m.*cp1_1m_conj + A_S2P1_00.*pol_sp_0.*cp1_0_conj + A_S2P1_01p.*pol_sp_p.*cp1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_01m.*pol_sp_m.*cp2_1m_conj + A_S2P2_00.*pol_sp_0.*cp2_0_conj + A_S2P2_01p.*pol_sp_p.*cp2_1p_conj));

cs2_1p_prime = -1i.*(Delta_S2P1 + Delta_S2P2 + Delta_zs2).*cs2_1p...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1p0.*pol_sp_m.*cp1_0 + A_S2P1_1p1p.*pol_sp_0.*cp1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1p0.*pol_sp_m.*cp2_0 + A_S2P2_1p1p.*pol_sp_0.*cp2_1p + A_S2P2_1p2p.*pol_sp_p.*cp2_2p);
cs2_1p_prime_conj = conj(-1i.*(Delta_S2P1 + Delta_S2P2 + Delta_zs2).*cs2_1p_conj...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1p0.*pol_sp_m.*cp1_0_conj + A_S2P1_1p1p.*pol_sp_0.*cp1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1p0.*pol_sp_m.*cp2_0_conj + A_S2P2_1p1p.*pol_sp_0.*cp2_1p_conj + A_S2P2_1p2p.*pol_sp_p.*cp2_2p_conj));

cs2_2p_prime = -1i.*(Delta_S2P1 + Delta_S2P2 + 2.*Delta_zs2).*cs2_2p...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2p1p.*pol_sp_m.*cp1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2p1p.*pol_sp_m.*cp2_1p + A_S2P2_2p2p.*pol_sp_0.*cp2_2p);
cs2_2p_prime_conj = conj(-1i.*(Delta_S2P1 + Delta_S2P2 + 2.*Delta_zs2).*cs2_2p_conj...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2p1p.*pol_sp_m.*cp1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2p1p.*pol_sp_m.*cp2_1p_conj + A_S2P2_2p2p.*pol_sp_0.*cp2_2p_conj));

cd0_0_prime = -1i.*(Delta_D0P1).*cd0_0...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01m.*pol_dp_m.*cp1_1m + A_D0P1_00.*pol_dp_0.*cp1_0 + A_D0P1_01p.*pol_dp_p.*cp1_1p);
cd0_0_prime_conj = conj(-1i.*(Delta_D0P1).*cd0_0_conj...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01m.*pol_dp_m.*cp1_1m_conj + A_D0P1_00.*pol_dp_0.*cp1_0_conj + A_D0P1_01p.*pol_dp_p.*cp1_1p_conj));

cd1_1m_prime = -1i.*(Delta_D1P1 + Delta_D1P2 - Delta_zd1).*cd1_1m...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m1m.*pol_dp_0.*cp1_1m + A_D1P1_1m0.*pol_dp_p.*cp1_0)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m2m.*pol_dp_m.*cp2_2m + A_D1P2_1m1m.*pol_dp_0.*cp2_1m + A_D1P2_1m0.*pol_dp_p.*cp2_0);
cd1_1m_prime_conj = conj(-1i.*(Delta_D1P1 + Delta_D1P2 - Delta_zd1).*cd1_1m_conj...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m1m.*pol_dp_0.*cp1_1m_conj + A_D1P1_1m0.*pol_dp_p.*cp1_0_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m2m.*pol_dp_m.*cp2_2m_conj + A_D1P2_1m1m.*pol_dp_0.*cp2_1m_conj + A_D1P2_1m0.*pol_dp_p.*cp2_0_conj));

cd1_0_prime = -1i.*(Delta_D1P1 + Delta_D1P2).*cd1_0...
    -1i.*(Omega_D1P1/2).*(A_D1P1_01m.*pol_dp_m.*cp1_1m + A_D1P1_00.*pol_dp_0.*cp1_0 + A_D1P1_01p.*pol_dp_p.*cp1_1p)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_01m.*pol_dp_m.*cp2_1m + A_D1P2_00.*pol_dp_0.*cp2_0 + A_D1P2_01p.*pol_dp_p.*cp2_1p);
cd1_0_prime_conj = conj(-1i.*(Delta_D1P1 + Delta_D1P2).*cd1_0_conj...
    -1i.*(Omega_D1P1/2).*(A_D1P1_01m.*pol_dp_m.*cp1_1m_conj + A_D1P1_00.*pol_dp_0.*cp1_0_conj + A_D1P1_01p.*pol_dp_p.*cp1_1p_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_01m.*pol_dp_m.*cp2_1m_conj + A_D1P2_00.*pol_dp_0.*cp2_0_conj + A_D1P2_01p.*pol_dp_p.*cp2_1p_conj));

cd1_1p_prime = -1i.*(Delta_D1P1 + Delta_D1P2 + Delta_zd1).*cd1_1p...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1p0.*pol_dp_m.*cp1_0 + A_D1P1_1p1p.*pol_dp_0.*cp1_1p)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1p0.*pol_dp_m.*cp2_0 + A_D1P2_1p1p.*pol_dp_0.*cp2_1p + A_D1P2_1p2p.*pol_dp_p.*cp2_2p);
cd1_1p_prime_conj = conj(-1i.*(Delta_D1P1 + Delta_D1P2 + Delta_zd1).*cd1_1p_conj...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1p0.*pol_dp_m.*cp1_0_conj + A_D1P1_1p1p.*pol_dp_0.*cp1_1p_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1p0.*pol_dp_m.*cp2_0_conj + A_D1P2_1p1p.*pol_dp_0.*cp2_1p_conj + A_D1P2_1p2p.*pol_dp_p.*cp2_2p_conj));

cd2_2m_prime = -1i.*(Delta_D2P1 + Delta_D2P2 - 2.*Delta_zd2).*cd2_2m...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2m1m.*pol_dp_p.*cp1_1m)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m2m.*pol_dp_0.*cp2_2m + A_D2P2_2m1m.*pol_dp_p.*cp2_1m);
cd2_2m_prime_conj = conj(-1i.*(Delta_D2P1 + Delta_D2P2 - 2.*Delta_zd2).*cd2_2m_conj...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2m1m.*pol_dp_p.*cp1_1m_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m2m.*pol_dp_0.*cp2_2m_conj + A_D2P2_2m1m.*pol_dp_p.*cp2_1m_conj));

cd2_1m_prime = -1i.*(Delta_D2P1 + Delta_D2P2 - Delta_zd2).*cd2_1m...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1m1m.*pol_dp_0.*cp1_1m + A_D2P1_1m0.*pol_dp_p.*cp1_0)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1m2m.*pol_dp_m.*cp2_2m + A_D2P2_1m1m.*pol_dp_0.*cp2_1m + A_D2P2_1m0.*pol_dp_p.*cp2_0);
cd2_1m_prime_conj = conj(-1i.*(Delta_D2P1 + Delta_D2P2 - Delta_zd2).*cd2_1m_conj...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1m1m.*pol_dp_0.*cp1_1m_conj + A_D2P1_1m0.*pol_dp_p.*cp1_0_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1m2m.*pol_dp_m.*cp2_2m_conj + A_D2P2_1m1m.*pol_dp_0.*cp2_1m_conj + A_D2P2_1m0.*pol_dp_p.*cp2_0_conj));

cd2_0_prime = -1i.*(Delta_D2P1 + Delta_D2P2).*cd2_0...
    -1i.*(Omega_D2P1/2).*(A_D2P1_01m.*pol_dp_m.*cp1_1m + A_D2P1_00.*pol_dp_0.*cp1_0 + A_D2P1_01p.*pol_dp_p.*cp1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_01m.*pol_dp_m.*cp2_1m + A_D2P2_00.*pol_dp_0.*cp2_0 + A_D2P2_01p.*pol_dp_p.*cp2_1p);
cd2_0_prime_conj = conj(-1i.*(Delta_D2P1 + Delta_D2P2).*cd2_0_conj...
    -1i.*(Omega_D2P1/2).*(A_D2P1_01m.*pol_dp_m.*cp1_1m_conj + A_D2P1_00.*pol_dp_0.*cp1_0_conj + A_D2P1_01p.*pol_dp_p.*cp1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_01m.*pol_dp_m.*cp2_1m_conj + A_D2P2_00.*pol_dp_0.*cp2_0_conj + A_D2P2_01p.*pol_dp_p.*cp2_1p_conj));

cd2_1p_prime = -1i.*(Delta_D2P1 + Delta_D2P2 + Delta_zd2).*cd2_1p...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1p0.*pol_dp_m.*cp1_0 + A_D2P1_1p1p.*pol_dp_0.*cp1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1p0.*pol_dp_m.*cp2_0 + A_D2P2_1p1p.*pol_dp_0.*cp2_1p + A_D2P2_1p2p.*pol_dp_p.*cp2_2p);
cd2_1p_prime_conj = conj(-1i.*(Delta_D2P1 + Delta_D2P2 + Delta_zd2).*cd2_1p_conj...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1p0.*pol_dp_m.*cp1_0_conj + A_D2P1_1p1p.*pol_dp_0.*cp1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1p0.*pol_dp_m.*cp2_0_conj + A_D2P2_1p1p.*pol_dp_0.*cp2_1p_conj + A_D2P2_1p2p.*pol_dp_p.*cp2_2p_conj));

cd2_2p_prime = -1i.*(Delta_D2P1 + Delta_D2P2 + 2.*Delta_zd2).*cd2_2p...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2p1p.*pol_dp_m.*cp1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2p1p.*pol_dp_m.*cp2_1p + A_D2P2_2p2p.*pol_dp_0.*cp2_2p);
cd2_2p_prime_conj = conj(-1i.*(Delta_D2P1 + Delta_D2P2 + 2.*Delta_zd2).*cd2_2p_conj...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2p1p.*pol_dp_m.*cp1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2p1p.*pol_dp_m.*cp2_1p_conj + A_D2P2_2p2p.*pol_dp_0.*cp2_2p_conj));

cd3_3m_prime = -1i.*(Delta_D3P2 - 3.*Delta_zd3).*cd3_3m...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3m2m.*pol_dp_p.*cp2_2m);
cd3_3m_prime_conj = conj(-1i.*(Delta_D3P2 - 3.*Delta_zd3).*cd3_3m_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3m2m.*pol_dp_p.*cp2_2m_conj));

cd3_2m_prime = -1i.*(Delta_D3P2 - 2.*Delta_zd3).*cd3_2m...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2m2m.*pol_dp_0.*cp2_2m + A_D3P2_2m1m.*pol_dp_p.*cp2_1m);
cd3_2m_prime_conj = conj(-1i.*(Delta_D3P2 - 2.*Delta_zd3).*cd3_2m_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2m2m.*pol_dp_0.*cp2_2m_conj + A_D3P2_2m1m.*pol_dp_p.*cp2_1m_conj));

cd3_1m_prime = -1i.*(Delta_D3P2 - Delta_zd3).*cd3_1m...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1m2m.*pol_dp_m.*cp2_2m + A_D3P2_1m1m.*pol_dp_0.*cp2_1m + A_D3P2_1m0.*pol_dp_p.*cp2_0);
cd3_1m_prime_conj = conj(-1i.*(Delta_D3P2 - Delta_zd3).*cd3_1m_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1m2m.*pol_dp_m.*cp2_2m_conj + A_D3P2_1m1m.*pol_dp_0.*cp2_1m_conj + A_D3P2_1m0.*pol_dp_p.*cp2_0_conj));

cd3_0_prime = -1i.*(Delta_D3P2).*cd3_0...
    -1i.*(Omega_D3P2/2).*(A_D3P2_01m.*pol_dp_m.*cp2_1m + A_D3P2_00.*pol_dp_0.*cp2_0 + A_D3P2_01p.*pol_dp_p.*cp2_1p);
cd3_0_prime_conj = conj(-1i.*(Delta_D3P2).*cd3_0_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_01m.*pol_dp_m.*cp2_1m_conj + A_D3P2_00.*pol_dp_0.*cp2_0_conj + A_D3P2_01p.*pol_dp_p.*cp2_1p_conj));

cd3_1p_prime = -1i.*(Delta_D3P2 + Delta_zd3).*cd3_1p...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1p0.*pol_dp_m.*cp2_0 + A_D3P2_1p1p.*pol_dp_0.*cp2_1p + A_D3P2_1p2p.*pol_dp_p.*cp2_2p);
cd3_1p_prime_conj = conj(-1i.*(Delta_D3P2 + Delta_zd3).*cd3_1p_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1p0.*pol_dp_m.*cp2_0_conj + A_D3P2_1p1p.*pol_dp_0.*cp2_1p_conj + A_D3P2_1p2p.*pol_dp_p.*cp2_2p_conj));

cd3_2p_prime = -1i.*(Delta_D3P2 + 2.*Delta_zd3).*cd3_2p...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2p1p.*pol_dp_m.*cp2_1p + A_D3P2_2p2p.*pol_dp_0.*cp2_2p);
cd3_2p_prime_conj = conj(-1i.*(Delta_D3P2 + 2.*Delta_zd3).*cd3_2p_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2p1p.*pol_dp_m.*cp2_1p_conj + A_D3P2_2p2p.*pol_dp_0.*cp2_2p_conj));

cd3_3p_prime = -1i.*(Delta_D3P2 + 3.*Delta_zd3).*cd3_3p...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3p2p.*pol_dp_m.*cp2_2p);
cd3_3p_prime_conj = conj(-1i.*(Delta_D3P2 + 3.*Delta_zd3).*cd3_3p_conj...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3p2p.*pol_dp_m.*cp2_2p_conj));

cp1_1m_prime = -1i.*(-Delta_zp1).*cp1_1m...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m1m.*pol_sp_0.*cs1_1m + A_S1P1_01m.*pol_sp_m.*cs1_0)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2m1m.*pol_sp_p.*cs2_2m + A_S2P1_1m1m.*pol_sp_0.*cs2_1m + A_S2P1_01m.*pol_sp_m.*cs2_0)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01m.*pol_dp_m.*cd0_0)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m1m.*pol_dp_0.*cd1_1m + A_D1P1_01m.*pol_dp_m.*cd1_0)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2m1m.*pol_dp_p.*cd2_2m + A_D2P1_1m1m.*pol_dp_0.*cd2_1m + A_D2P1_01m.*pol_dp_m.*cd2_0);
cp1_1m_prime_conj = conj(-1i.*(-Delta_zp1).*cp1_1m_conj...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m1m.*pol_sp_0.*cs1_1m_conj + A_S1P1_01m.*pol_sp_m.*cs1_0_conj)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_2m1m.*pol_sp_p.*cs2_2m_conj + A_S2P1_1m1m.*pol_sp_0.*cs2_1m_conj + A_S2P1_01m.*pol_sp_m.*cs2_0_conj)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01m.*pol_dp_m.*cd0_0_conj)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m1m.*pol_dp_0.*cd1_1m_conj + A_D1P1_01m.*pol_dp_m.*cd1_0_conj)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_2m1m.*pol_dp_p.*cd2_2m_conj + A_D2P1_1m1m.*pol_dp_0.*cd2_1m_conj + A_D2P1_01m.*pol_dp_m.*cd2_0_conj));

cp1_0_prime = ...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m0.*pol_sp_p.*cs1_1m + A_S1P1_00.*pol_sp_0.*cs1_0 + A_S1P1_1p0.*pol_sp_m.*cs1_1p)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1m0.*pol_sp_p.*cs2_1m + A_S2P1_00.*pol_sp_0.*cs2_0 + A_S2P1_1p0.*pol_sp_m.*cs2_1p)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_00.*pol_dp_0.*cd0_0)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m0.*pol_dp_p.*cd1_1m + A_D1P1_00.*pol_dp_0.*cd1_0 + A_D1P1_1p0.*pol_dp_m.*cd1_1p)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1m0.*pol_dp_p.*cd2_1m + A_D2P1_00.*pol_dp_0.*cd2_0 + A_D2P1_1p0.*pol_dp_m.*cd2_1p);
cp1_0_prime_conj = conj(...
    -1i.*(Omega_S1P1/2).*(A_S1P1_1m0.*pol_sp_p.*cs1_1m_conj + A_S1P1_00.*pol_sp_0.*cs1_0_conj + A_S1P1_1p0.*pol_sp_m.*cs1_1p_conj)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_1m0.*pol_sp_p.*cs2_1m_conj + A_S2P1_00.*pol_sp_0.*cs2_0_conj + A_S2P1_1p0.*pol_sp_m.*cs2_1p_conj)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_00.*pol_dp_0.*cd0_0_conj)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_1m0.*pol_dp_p.*cd1_1m_conj + A_D1P1_00.*pol_dp_0.*cd1_0_conj + A_D1P1_1p0.*pol_dp_m.*cd1_1p_conj)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_1m0.*pol_dp_p.*cd2_1m_conj + A_D2P1_00.*pol_dp_0.*cd2_0_conj + A_D2P1_1p0.*pol_dp_m.*cd2_1p_conj));

cp1_1p_prime = -1i.*(Delta_zp1).*cp1_1p...
    -1i.*(Omega_S1P1/2).*(A_S1P1_01p.*pol_sp_p.*cs1_0 + A_S1P1_1p1p.*pol_sp_0.*cs1_1p)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_01p.*pol_sp_p.*cs2_0 + A_S2P1_1p1p.*pol_sp_0.*cs2_1p + A_S2P1_2p1p.*pol_sp_m.*cs2_2p)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01p.*pol_dp_p.*cd0_0)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_01p.*pol_dp_p.*cd1_0 + A_D1P1_1p1p.*pol_dp_0.*cd1_1p)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_01p.*pol_dp_p.*cd2_0 + A_D2P1_1p1p.*pol_dp_0.*cd2_1p + A_D2P1_2p1p.*pol_dp_m.*cd2_2p);
cp1_1p_prime_conj = conj(-1i.*(Delta_zp1).*cp1_1p_conj...
    -1i.*(Omega_S1P1/2).*(A_S1P1_01p.*pol_sp_p.*cs1_0_conj + A_S1P1_1p1p.*pol_sp_0.*cs1_1p_conj)...
    -1i.*(Omega_S2P1/2).*(A_S2P1_01p.*pol_sp_p.*cs2_0_conj + A_S2P1_1p1p.*pol_sp_0.*cs2_1p_conj + A_S2P1_2p1p.*pol_sp_m.*cs2_2p_conj)...
    -1i.*(Omega_D0P1/2).*(A_D0P1_01p.*pol_dp_p.*cd0_0_conj)...
    -1i.*(Omega_D1P1/2).*(A_D1P1_01p.*pol_dp_p.*cd1_0_conj + A_D1P1_1p1p.*pol_dp_0.*cd1_1p_conj)...
    -1i.*(Omega_D2P1/2).*(A_D2P1_01p.*pol_dp_p.*cd2_0_conj + A_D2P1_1p1p.*pol_dp_0.*cd2_1p_conj + A_D2P1_2p1p.*pol_dp_m.*cd2_2p_conj));

cp2_2m_prime = -1i.*(-2.*Delta_zp2).*cp2_2m...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m2m.*pol_sp_m.*cs1_1m)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m2m.*pol_sp_0.*cs2_2m + A_S2P2_1m2m.*pol_sp_m.*cs2_1m)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m2m.*pol_dp_m.*cd1_1m)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m2m.*pol_dp_0.*cd2_2m + A_D2P2_1m2m.*pol_dp_m.*cd2_1m)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3m2m.*pol_dp_p.*cd3_3m + A_D3P2_2m2m.*pol_dp_0.*cd3_2m + A_D3P2_1m2m.*pol_dp_m.*cd3_1m);
cp2_2m_prime_conj = conj(-1i.*(-2.*Delta_zp2).*cp2_2m_conj...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m2m.*pol_sp_m.*cs1_1m_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m2m.*pol_sp_0.*cs2_2m_conj + A_S2P2_1m2m.*pol_sp_m.*cs2_1m_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m2m.*pol_dp_m.*cd1_1m_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m2m.*pol_dp_0.*cd2_2m_conj + A_D2P2_1m2m.*pol_dp_m.*cd2_1m_conj)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_3m2m.*pol_dp_p.*cd3_3m_conj + A_D3P2_2m2m.*pol_dp_0.*cd3_2m_conj + A_D3P2_1m2m.*pol_dp_m.*cd3_1m_conj));

cp2_1m_prime = -1i.*(-Delta_zp2).*cp2_1m...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m1m.*pol_sp_0.*cs1_1m + A_S1P2_01m.*pol_sp_m.*cs1_0)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m1m.*pol_sp_p.*cs2_2m + A_S2P2_1m1m.*pol_sp_0.*cs2_1m + A_S2P2_01m.*pol_sp_m.*cs2_0)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m1m.*pol_dp_0.*cd1_1m + A_D1P2_01m.*pol_dp_m.*cd1_0)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m1m.*pol_dp_p.*cd2_2m + A_D2P2_1m1m.*pol_dp_0.*cd2_1m + A_D2P2_01m.*pol_dp_m.*cd2_0)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2m1m.*pol_dp_p.*cd3_2m + A_D3P2_1m1m.*pol_dp_0.*cd3_1m + A_D3P2_01m.*pol_dp_m.*cd3_0);
cp2_1m_prime_conj = conj(-1i.*(-Delta_zp2).*cp2_1m_conj...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m1m.*pol_sp_0.*cs1_1m_conj + A_S1P2_01m.*pol_sp_m.*cs1_0_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_2m1m.*pol_sp_p.*cs2_2m_conj + A_S2P2_1m1m.*pol_sp_0.*cs2_1m_conj + A_S2P2_01m.*pol_sp_m.*cs2_0_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m1m.*pol_dp_0.*cd1_1m_conj + A_D1P2_01m.*pol_dp_m.*cd1_0_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_2m1m.*pol_dp_p.*cd2_2m_conj + A_D2P2_1m1m.*pol_dp_0.*cd2_1m_conj + A_D2P2_01m.*pol_dp_m.*cd2_0_conj)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_2m1m.*pol_dp_p.*cd3_2m_conj + A_D3P2_1m1m.*pol_dp_0.*cd3_1m_conj + A_D3P2_01m.*pol_dp_m.*cd3_0_conj));

cp2_0_prime = ...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m0.*pol_sp_p.*cs1_1m + A_S1P2_00.*pol_sp_0.*cs1_0 + A_S1P2_1p0.*pol_sp_m.*cs1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1m0.*pol_sp_p.*cs2_1m + A_S2P2_00.*pol_sp_0.*cs2_0 + A_S2P2_1p0.*pol_sp_m.*cs2_1p)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m0.*pol_dp_p.*cd1_1m + A_D1P2_00.*pol_dp_0.*cd1_0 + A_D1P2_1p0.*pol_dp_m.*cd1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1m0.*pol_dp_p.*cd2_1m + A_D2P2_00.*pol_dp_0.*cd2_0 + A_D2P2_1p0.*pol_dp_m.*cd2_1p)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1m0.*pol_dp_p.*cd3_1m + A_D3P2_00.*pol_dp_0.*cd3_0 + A_D3P2_1p0.*pol_dp_m.*cd3_1p);
cp2_0_prime_conj = conj(...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1m0.*pol_sp_p.*cs1_1m_conj + A_S1P2_00.*pol_sp_0.*cs1_0_conj + A_S1P2_1p0.*pol_sp_m.*cs1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1m0.*pol_sp_p.*cs2_1m_conj + A_S2P2_00.*pol_sp_0.*cs2_0_conj + A_S2P2_1p0.*pol_sp_m.*cs2_1p_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1m0.*pol_dp_p.*cd1_1m_conj + A_D1P2_00.*pol_dp_0.*cd1_0_conj + A_D1P2_1p0.*pol_dp_m.*cd1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1m0.*pol_dp_p.*cd2_1m_conj + A_D2P2_00.*pol_dp_0.*cd2_0_conj + A_D2P2_1p0.*pol_dp_m.*cd2_1p_conj)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1m0.*pol_dp_p.*cd3_1m_conj + A_D3P2_00.*pol_dp_0.*cd3_0_conj + A_D3P2_1p0.*pol_dp_m.*cd3_1p_conj));

cp2_1p_prime = -1i.*(Delta_zp2).*cp2_1p...
    -1i.*(Omega_S1P2/2).*(A_S1P2_01p.*pol_sp_p.*cs1_0 + A_S1P2_1p1p.*pol_sp_0.*cs1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_01p.*pol_sp_p.*cs2_0 + A_S2P2_1p1p.*pol_sp_0.*cs2_1p + A_S2P2_2p1p.*pol_sp_m.*cs2_2p)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_01p.*pol_dp_p.*cd1_0 + A_D1P2_1p1p.*pol_dp_0.*cd1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_01p.*pol_dp_p.*cd2_0 + A_D2P2_1p1p.*pol_dp_0.*cd2_1p + A_D2P2_2p1p.*pol_dp_m.*cd2_2p)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_01p.*pol_dp_p.*cd3_0 + A_D3P2_1p1p.*pol_dp_0.*cd3_1p + A_D3P2_2p1p.*pol_dp_m.*cd3_2p);
cp2_1p_prime_conj = conj(-1i.*(Delta_zp2).*cp2_1p_conj...
    -1i.*(Omega_S1P2/2).*(A_S1P2_01p.*pol_sp_p.*cs1_0_conj + A_S1P2_1p1p.*pol_sp_0.*cs1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_01p.*pol_sp_p.*cs2_0_conj + A_S2P2_1p1p.*pol_sp_0.*cs2_1p_conj + A_S2P2_2p1p.*pol_sp_m.*cs2_2p_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_01p.*pol_dp_p.*cd1_0_conj + A_D1P2_1p1p.*pol_dp_0.*cd1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_01p.*pol_dp_p.*cd2_0_conj + A_D2P2_1p1p.*pol_dp_0.*cd2_1p_conj + A_D2P2_2p1p.*pol_dp_m.*cd2_2p_conj)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_01p.*pol_dp_p.*cd3_0_conj + A_D3P2_1p1p.*pol_dp_0.*cd3_1p_conj + A_D3P2_2p1p.*pol_dp_m.*cd3_2p_conj));

cp2_2p_prime = -1i.*(2.*Delta_zp2).*cp2_2p...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1p2p.*pol_sp_p.*cs1_1p)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1p2p.*pol_sp_p.*cs2_1p + A_S2P2_2p2p.*pol_sp_0.*cs2_2p)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1p2p.*pol_dp_p.*cd1_1p)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1p2p.*pol_dp_p.*cd2_1p + A_D2P2_2p2p.*pol_dp_0.*cd2_2p)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1p2p.*pol_dp_p.*cd3_1p + A_D3P2_2p2p.*pol_dp_0.*cd3_2p + A_D3P2_3p2p.*pol_dp_m.*cd3_3p);
cp2_2p_prime_conj = conj(-1i.*(2.*Delta_zp2).*cp2_2p_conj...
    -1i.*(Omega_S1P2/2).*(A_S1P2_1p2p.*pol_sp_p.*cs1_1p_conj)...
    -1i.*(Omega_S2P2/2).*(A_S2P2_1p2p.*pol_sp_p.*cs2_1p_conj + A_S2P2_2p2p.*pol_sp_0.*cs2_2p_conj)...
    -1i.*(Omega_D1P2/2).*(A_D1P2_1p2p.*pol_dp_p.*cd1_1p_conj)...
    -1i.*(Omega_D2P2/2).*(A_D2P2_1p2p.*pol_dp_p.*cd2_1p_conj + A_D2P2_2p2p.*pol_dp_0.*cd2_2p_conj)...
    -1i.*(Omega_D3P2/2).*(A_D3P2_1p2p.*pol_dp_p.*cd3_1p_conj + A_D3P2_2p2p.*pol_dp_0.*cd3_2p_conj + A_D3P2_3p2p.*pol_dp_m.*cd3_3p_conj));

%Lines 530 to 596 combine the 1D arrays of the first derivative of each
%state into 2 2D arrays.
c_prime_array = [...
    cs1_1m_prime;...
    cs1_0_prime;...
    cs1_1p_prime;...
    cs2_2m_prime;...
    cs2_1m_prime;...
    cs2_0_prime;...
    cs2_1p_prime;...
    cs2_2p_prime;...
    cd0_0_prime;...
    cd1_1m_prime;...
    cd1_0_prime;...
    cd1_1p_prime;...
    cd2_2m_prime;...
    cd2_1m_prime;...
    cd2_0_prime;...
    cd2_1p_prime;...
    cd2_2p_prime;...
    cd3_3m_prime;...
    cd3_2m_prime;...
    cd3_1m_prime;...
    cd3_0_prime;...
    cd3_1p_prime;...
    cd3_2p_prime;...
    cd3_3p_prime;...
    cp1_1m_prime;...
    cp1_0_prime;...
    cp1_1p_prime;...
    cp2_2m_prime;...
    cp2_1m_prime;...
    cp2_0_prime;...
    cp2_1p_prime;...
    cp2_2p_prime];
    
c_prime_conj_array = [...
    cs1_1m_prime_conj;...
    cs1_0_prime_conj;...
    cs1_1p_prime_conj;...
    cs2_2m_prime_conj;...
    cs2_1m_prime_conj;...
    cs2_0_prime_conj;...
    cs2_1p_prime_conj;...
    cs2_2p_prime_conj;...
    cd0_0_prime_conj;...
    cd1_1m_prime_conj;...
    cd1_0_prime_conj;...
    cd1_1p_prime_conj;...
    cd2_2m_prime_conj;...
    cd2_1m_prime_conj;...
    cd2_0_prime_conj;...
    cd2_1p_prime_conj;...
    cd2_2p_prime_conj;...
    cd3_3m_prime_conj;...
    cd3_2m_prime_conj;...
    cd3_1m_prime_conj;...
    cd3_0_prime_conj;...
    cd3_1p_prime_conj;...
    cd3_2p_prime_conj;...
    cd3_3p_prime_conj;...
    cp1_1m_prime_conj;...
    cp1_0_prime_conj;...
    cp1_1p_prime_conj;...
    cp2_2m_prime_conj;...
    cp2_1m_prime_conj;...
    cp2_0_prime_conj;...
    cp2_1p_prime_conj;...
    cp2_2p_prime_conj];

Evol_Matrix = nan(numel(cs1_0),numel(cs1_0)); %Initialize the matrix for 
%state evolution.

%Lines 602 to 757 assign the elements of the evolution matrix.
for EM_count1 = 1:numel(s1_0)
    for EM_count2 = 1:numel(s1_0)
        Pcount = 0;
        if EM_count1 >= 25
            Pcount = Pcount+1;
        end
        if EM_count2 >= 25
            Pcount = Pcount+1;
        end
        Evol_Matrix(c_array(EM_count1,:).*c_conj_array(EM_count2,:) == 1,:) =...
            c_array(EM_count1,:).*c_prime_conj_array(EM_count2,:) + c_prime_array(EM_count1,:).*c_conj_array(EM_count2,:)...
            - (1/2).*Pcount.*(gamma_S + gamma_D).*c_array(EM_count1,:).*c_conj_array(EM_count2,:);
    end
end     

Evol_Matrix(cs1_1m.*cs1_1m_conj == 1,:) = cs1_1m.*cs1_1m_prime_conj + cs1_1m_prime.*cs1_1m_conj...
    + W_S1P1_1m1m.*gamma_S.*cp1_1m.*cp1_1m_conj...
    + W_S1P1_1m0.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S1P2_1m2m.*gamma_S.*cp2_2m.*cp2_2m_conj...
    + W_S1P2_1m1m.*gamma_S.*cp2_1m.*cp2_1m_conj...
    + W_S1P2_1m0.*gamma_S.*cp2_0.*cp2_0_conj;

Evol_Matrix(cs1_0.*cs1_0_conj == 1,:) = cs1_0.*cs1_0_prime_conj + cs1_0_prime.*cs1_0_conj...
    + W_S1P1_01m.*gamma_S.*cp1_1m.*cp1_1m_conj...
    + W_S1P1_00.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S1P1_01p.*gamma_S.*cp1_1p.*cp1_1p_conj...
    + W_S1P2_01m.*gamma_S.*cp2_1m.*cp2_1m_conj...
    + W_S1P2_00.*gamma_S.*cp2_0.*cp2_0_conj...
    + W_S1P2_01p.*gamma_S.*cp2_1p.*cp2_1p_conj;

Evol_Matrix(cs1_1p.*cs1_1p_conj == 1,:) = cs1_1p.*cs1_1p_prime_conj + cs1_1p_prime.*cs1_1p_conj...
    + W_S1P1_1p0.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S1P1_1p1p.*gamma_S.*cp1_1p.*cp1_1p_conj...
    + W_S1P2_1p0.*gamma_S.*cp2_0.*cp2_0_conj...
    + W_S1P2_1p1p.*gamma_S.*cp2_1p.*cp2_1p_conj...
    + W_S1P2_1p2p.*gamma_S.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cs2_2m.*cs2_2m_conj == 1,:) = cs2_2m.*cs2_2m_prime_conj + cs2_2m_prime.*cs2_2m_conj...
    + W_S2P1_2m1m.*gamma_S.*cp1_1m.*cp1_1m_conj...
    + W_S2P2_2m2m.*gamma_S.*cp2_2m.*cp2_2m_conj...
    + W_S2P2_2m1m.*gamma_S.*cp2_1m.*cp2_1m_conj;

Evol_Matrix(cs2_1m.*cs2_1m_conj == 1,:) = cs2_1m.*cs2_1m_prime_conj + cs2_1m_prime.*cs2_1m_conj...
    + W_S2P1_1m1m.*gamma_S.*cp1_1m.*cp1_1m_conj...
    + W_S2P1_1m0.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S2P2_1m2m.*gamma_S.*cp2_2m.*cp2_2m_conj...
    + W_S2P2_1m1m.*gamma_S.*cp2_1m.*cp2_1m_conj...
    + W_S2P2_1m0.*gamma_S.*cp2_0.*cp2_0_conj;

Evol_Matrix(cs2_0.*cs2_0_conj == 1,:) = cs2_0.*cs2_0_prime_conj + cs2_0_prime.*cs2_0_conj...
    + W_S2P1_01m.*gamma_S.*cp1_1m.*cp1_1m_conj...
    + W_S2P1_00.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S2P1_01p.*gamma_S.*cp1_1p.*cp1_1p_conj...
    + W_S2P2_01m.*gamma_S.*cp2_1m.*cp2_1m_conj...
    + W_S2P2_00.*gamma_S.*cp2_0.*cp2_0_conj...
    + W_S2P2_01p.*gamma_S.*cp2_1p.*cp2_1p_conj;

Evol_Matrix(cs2_1p.*cs2_1p_conj == 1,:) = cs2_1p.*cs2_1p_prime_conj + cs2_1p_prime.*cs2_1p_conj...
    + W_S2P1_1p0.*gamma_S.*cp1_0.*cp1_0_conj...
    + W_S2P1_1p1p.*gamma_S.*cp1_1p.*cp1_1p_conj...
    + W_S2P2_1p0.*gamma_S.*cp2_0.*cp2_0_conj...
    + W_S2P2_1p1p.*gamma_S.*cp2_1p.*cp2_1p_conj...
    + W_S2P2_1p2p.*gamma_S.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cs2_2p.*cs2_2p_conj == 1,:) = cs2_2p.*cs2_2p_prime_conj + cs2_2p_prime.*cs2_2p_conj...
    + W_S2P1_2p1p.*gamma_S.*cp1_1p.*cp1_1p_conj...
    + W_S2P2_2p1p.*gamma_S.*cp2_1p.*cp2_1p_conj...
    + W_S2P2_2p2p.*gamma_S.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd0_0.*cd0_0_conj == 1,:) = cd0_0.*cd0_0_prime_conj + cd0_0_prime.*cd0_0_conj...
    + W_D0P1_01m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D0P1_00.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D0P1_01p.*gamma_D.*cp1_1p.*cp1_1p_conj;

Evol_Matrix(cd1_1m.*cd1_1m_conj == 1,:) = cd1_1m.*cd1_1m_prime_conj + cd1_1m_prime.*cd1_1m_conj...
    + W_D1P1_1m1m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D1P1_1m0.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D1P2_1m2m.*gamma_D.*cp2_2m.*cp2_2m_conj...
    + W_D1P2_1m1m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D1P2_1m0.*gamma_D.*cp2_0.*cp2_0_conj;

Evol_Matrix(cd1_0.*cd1_0_conj == 1,:) = cd1_0.*cd1_0_prime_conj + cd1_0_prime.*cd1_0_conj...
    + W_D1P1_01m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D1P1_00.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D1P1_01p.*gamma_D.*cp1_1p.*cp1_1p_conj...
    + W_D1P2_01m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D1P2_00.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D1P2_01p.*gamma_D.*cp2_1p.*cp2_1p_conj;

Evol_Matrix(cd1_1p.*cd1_1p_conj == 1,:) = cd1_1p.*cd1_1p_prime_conj + cd1_1p_prime.*cd1_1p_conj...
    + W_D1P1_1p0.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D1P1_1p1p.*gamma_D.*cp1_1p.*cp1_1p_conj...
    + W_D1P2_1p0.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D1P2_1p1p.*gamma_D.*cp2_1p.*cp2_1p_conj...
    + W_D1P2_1p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd2_2m.*cd2_2m_conj == 1,:) = cd2_2m.*cd2_2m_prime_conj + cd2_2m_prime.*cd2_2m_conj...
    + W_D2P1_2m1m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D2P2_2m2m.*gamma_D.*cp2_2m.*cp2_2m_conj...
    + W_D2P2_2m1m.*gamma_D.*cp2_1m.*cp2_1m_conj;

Evol_Matrix(cd2_1m.*cd2_1m_conj == 1,:) = cd2_1m.*cd2_1m_prime_conj + cd2_1m_prime.*cd2_1m_conj...
    + W_D2P1_1m1m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D2P1_1m0.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D2P2_1m2m.*gamma_D.*cp2_2m.*cp2_2m_conj...
    + W_D2P2_1m1m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D2P2_1m0.*gamma_D.*cp2_0.*cp2_0_conj;

Evol_Matrix(cd2_0.*cd2_0_conj == 1,:) = cd2_0.*cd2_0_prime_conj + cd2_0_prime.*cd2_0_conj...
    + W_D2P1_01m.*gamma_D.*cp1_1m.*cp1_1m_conj...
    + W_D2P1_00.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D2P1_01p.*gamma_D.*cp1_1p.*cp1_1p_conj...
    + W_D2P2_01m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D2P2_00.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D2P2_01p.*gamma_D.*cp2_1p.*cp2_1p_conj;

Evol_Matrix(cd2_1p.*cd2_1p_conj == 1,:) = cd2_1p.*cd2_1p_prime_conj + cd2_1p_prime.*cd2_1p_conj...
    + W_D2P1_1p0.*gamma_D.*cp1_0.*cp1_0_conj...
    + W_D2P1_1p1p.*gamma_D.*cp1_1p.*cp1_1p_conj...
    + W_D2P2_1p0.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D2P2_1p1p.*gamma_D.*cp2_1p.*cp2_1p_conj...
    + W_D2P2_1p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd2_2p.*cd2_2p_conj == 1,:) = cd2_2p.*cd2_2p_prime_conj + cd2_2p_prime.*cd2_2p_conj...
    + W_D2P1_2p1p.*gamma_D.*cp1_1p.*cp1_1p_conj...
    + W_D2P2_2p1p.*gamma_D.*cp2_1p.*cp2_1p_conj...
    + W_D2P2_2p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd3_3m.*cd3_3m_conj == 1,:) = cd3_3m.*cd3_3m_prime_conj + cd3_3m_prime.*cd3_3m_conj...
    + W_D3P2_3m2m.*gamma_D.*cp2_2m.*cp2_2m_conj;

Evol_Matrix(cd3_2m.*cd3_2m_conj == 1,:) = cd3_2m.*cd3_2m_prime_conj + cd3_2m_prime.*cd3_2m_conj...
    + W_D3P2_2m2m.*gamma_D.*cp2_2m.*cp2_2m_conj...
    + W_D3P2_2m1m.*gamma_D.*cp2_1m.*cp2_1m_conj;

Evol_Matrix(cd3_1m.*cd3_1m_conj == 1,:) = cd3_1m.*cd3_1m_prime_conj + cd3_1m_prime.*cd3_1m_conj...
    + W_D3P2_1m2m.*gamma_D.*cp2_2m.*cp2_2m_conj...
    + W_D3P2_1m1m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D3P2_1m0.*gamma_D.*cp2_0.*cp2_0_conj;

Evol_Matrix(cd3_0.*cd3_0_conj == 1,:) = cd3_0.*cd3_0_prime_conj + cd3_0_prime.*cd3_0_conj...
    + W_D3P2_01m.*gamma_D.*cp2_1m.*cp2_1m_conj...
    + W_D3P2_00.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D3P2_01p.*gamma_D.*cp2_1p.*cp2_1p_conj;

Evol_Matrix(cd3_1p.*cd3_1p_conj == 1,:) = cd3_1p.*cd3_1p_prime_conj + cd3_1p_prime.*cd3_1p_conj...
    + W_D3P2_1p0.*gamma_D.*cp2_0.*cp2_0_conj...
    + W_D3P2_1p1p.*gamma_D.*cp2_1p.*cp2_1p_conj...
    + W_D3P2_1p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd3_2p.*cd3_2p_conj == 1,:) = cd3_2p.*cd3_2p_prime_conj + cd3_2p_prime.*cd3_2p_conj...
    + W_D3P2_2p1p.*gamma_D.*cp2_1p.*cp2_1p_conj...
    + W_D3P2_2p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

Evol_Matrix(cd3_3p.*cd3_3p_conj == 1,:) = cd3_3p.*cd3_3p_prime_conj + cd3_3p_prime.*cd3_3p_conj...
    + W_D3P2_3p2p.*gamma_D.*cp2_2p.*cp2_2p_conj;

%Lines 760 to 763 adds the condition that the trace of the density matrix
%has to be 1.
Evol_Matrix(end+1,:) = zeros(1,size(Evol_Matrix,2));
for EM_count=1:numel(s1_0)
    Evol_Matrix(end,c_array(EM_count,:).*c_conj_array(EM_count,:) == 1) = 1;
end

sigma_end = linsolve(Evol_Matrix,[zeros(size(Evol_Matrix,2),1); 1]); %Solves
%the simultaneous equations for the case where all the derivatives are
%zeros and the trace of the density matrix is one.